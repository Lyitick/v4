===== Bot/utils/__init__.py =====



===== Bot/utils/datetime_utils.py =====


"""Datetime utilities for the bot."""
from datetime import datetime, time, timedelta

from Bot.config import settings


def now_tz() -> datetime:
    """Return current datetime in configured timezone."""

    return datetime.now(tz=settings.TIMEZONE)


def current_month_str(now: datetime | None = None) -> str:
    """Return current month label as YYYY-MM using configured timezone."""

    current = now or now_tz()
    return f"{current.year:04d}-{current.month:02d}"


def add_one_month(source: datetime) -> datetime:
    """Add one calendar month to datetime without external dependencies."""

    year = source.year + (source.month // 12)
    month = 1 if source.month == 12 else source.month + 1
    last_day = (
        (source.replace(day=1) + timedelta(days=32)).replace(day=1) - timedelta(days=1)
    ).day
    day = min(source.day, last_day)
    return source.replace(year=year, month=month, day=day)


def get_next_byt_run_dt(now: datetime, schedule_times: list[time]) -> datetime:
    """Return next BYT reminder datetime based on schedule times."""

    if not schedule_times:
        return now

    sorted_times = sorted(
        schedule_times, key=lambda value: (value.hour, value.minute, value.second)
    )
    candidates = [
        now.replace(
            hour=slot.hour,
            minute=slot.minute,
            second=slot.second,
            microsecond=0,
        )
        for slot in sorted_times
    ]
    for candidate in candidates:
        if candidate >= now:
            return candidate
    return candidates[0] + timedelta(days=1)


def resolve_deferred_until(
    existing: datetime | None, candidate: datetime
) -> datetime:
    """Pick later deferred_until value."""

    if existing and existing > candidate:
        return existing
    return candidate

===== Bot/utils/logging.py =====


"""Logging utilities."""
import logging

from Bot.config.logging_config import setup_logging


def init_logging() -> logging.Logger:
    """Initialize logging and return module logger.

    Returns:
        logging.Logger: Configured logger instance.
    """

    setup_logging()
    return logging.getLogger(__name__)

===== Bot/utils/savings.py =====


"""Savings utility helpers."""
from typing import Any, Dict, List, Tuple


def _fallback_humanize_category(category: str) -> str:
    name = str(category)
    if name.startswith("savings_"):
        name = name[len("savings_") :]
    name = name.replace("_", " ").strip()
    return name or str(category)


def format_savings_summary(
    savings: Dict[str, Dict[str, Any]],
    categories_map: Dict[str, str] | None = None,
) -> str:
    """Format savings summary for user message."""

    if not savings:
        return "Пока нет накоплений."

    lines: List[str] = []
    for category, data in savings.items():
        display_name = None
        if categories_map is not None:
            display_name = categories_map.get(str(category))
        if not display_name:
            display_name = _fallback_humanize_category(str(category))
        current = data.get("current", 0)
        goal = data.get("goal", 0)
        purpose = data.get("purpose", "")
        line = f"{display_name}: {current:.2f}"
        if goal and goal > 0:
            progress = min(current / goal * 100, 100)
            extra = f" (цель {goal:.2f} для '{purpose}', прогресс {progress:.1f}%)"
            line = f"{line}{extra}"
        lines.append(line)
    return "\n".join(lines)


def find_reached_goal(
    savings: Dict[str, Dict[str, Any]]
) -> Tuple[str, Dict[str, Any]] | Tuple[None, None]:
    """Find first saving goal that has been reached."""

    for category, data in savings.items():
        current = data.get("current", 0)
        goal = data.get("goal", 0)
        if goal and current >= goal:
            return category, data
    return None, None

===== Bot/utils/telegram_safe.py =====


"""Safe wrappers for Telegram API operations."""
from __future__ import annotations

import asyncio
import logging

from aiohttp import ClientConnectionError, ClientOSError
from aiogram.exceptions import TelegramBadRequest, TelegramNetworkError
from aiogram.types import ReplyKeyboardMarkup, ReplyKeyboardRemove

LOGGER = logging.getLogger(__name__)

DEFAULT_REQUEST_TIMEOUT = 30


def _get_logger(logger: logging.Logger | None) -> logging.Logger:
    return logger or LOGGER


def _is_network_error(exc: Exception) -> bool:
    return isinstance(
        exc,
        (
            TelegramNetworkError,
            ClientOSError,
            ClientConnectionError,
            asyncio.TimeoutError,
            TimeoutError,
        ),
    )


def _log_network_error(
    logger: logging.Logger,
    action: str,
    exc: Exception,
    attempt: int,
    retries: int,
) -> None:
    logger.warning(
        "NETWORK_RETRY action=%s attempt=%s/%s error=%s",
        action,
        attempt,
        retries + 1,
        exc,
    )
    if logger.isEnabledFor(logging.DEBUG):
        logger.debug("Network error details for %s", action, exc_info=True)


async def safe_delete_message(
    bot,
    chat_id: int,
    message_id: int,
    *,
    retries: int = 2,
    base_delay: float = 0.3,
    logger: logging.Logger | None = None,
    request_timeout: int | None = DEFAULT_REQUEST_TIMEOUT,
) -> bool:
    """Safely delete a message without raising exceptions."""

    log = _get_logger(logger)
    for attempt in range(retries + 1):
        try:
            await bot.delete_message(
                chat_id=chat_id,
                message_id=message_id,
                request_timeout=request_timeout,
            )
            return True
        except TelegramBadRequest as exc:
            text = str(exc).lower()
            if (
                "message to delete not found" in text
                or "message can't be deleted" in text
                or "message can’t be deleted" in text
            ):
                log.debug(
                    "Safe delete skipped (chat_id=%s, message_id=%s): %s",
                    chat_id,
                    message_id,
                    exc,
                )
                return False
            log.warning(
                "Safe delete failed (chat_id=%s, message_id=%s): %s",
                chat_id,
                message_id,
                exc,
            )
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe delete failure details", exc_info=True)
            return False
        except Exception as exc:  # noqa: BLE001
            if _is_network_error(exc):
                _log_network_error(log, "delete_message", exc, attempt + 1, retries)
                if attempt < retries:
                    await asyncio.sleep(base_delay * 2**attempt)
                    continue
                return False
            log.warning(
                "Safe delete unexpected error (chat_id=%s, message_id=%s): %s",
                chat_id,
                message_id,
                exc,
            )
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe delete unexpected error details", exc_info=True)
            return False
    return False


async def safe_edit_message_text(
    bot,
    chat_id: int,
    message_id: int,
    text: str,
    reply_markup=None,
    *,
    parse_mode: str | None = None,
    retries: int = 2,
    base_delay: float = 0.3,
    logger: logging.Logger | None = None,
    request_timeout: int | None = DEFAULT_REQUEST_TIMEOUT,
) -> bool:
    """Safely edit a message text without raising exceptions."""

    log = _get_logger(logger)
    if isinstance(reply_markup, (ReplyKeyboardMarkup, ReplyKeyboardRemove)):
        log.warning("Safe edit skipped due to reply keyboard markup")
        return False

    for attempt in range(retries + 1):
        try:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=text,
                reply_markup=reply_markup,
                parse_mode=parse_mode,
                request_timeout=request_timeout,
            )
            return True
        except TelegramBadRequest as exc:
            lowered = str(exc).lower()
            if "message is not modified" in lowered:
                return True
            if "message to edit not found" in lowered:
                log.debug(
                    "Safe edit skipped (chat_id=%s, message_id=%s): %s",
                    chat_id,
                    message_id,
                    exc,
                )
                return False
            log.warning(
                "Safe edit failed (chat_id=%s, message_id=%s): %s",
                chat_id,
                message_id,
                exc,
            )
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe edit failure details", exc_info=True)
            return False
        except Exception as exc:  # noqa: BLE001
            if _is_network_error(exc):
                _log_network_error(log, "edit_message_text", exc, attempt + 1, retries)
                if attempt < retries:
                    await asyncio.sleep(base_delay * 2**attempt)
                    continue
                return False
            log.warning(
                "Safe edit unexpected error (chat_id=%s, message_id=%s): %s",
                chat_id,
                message_id,
                exc,
            )
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe edit unexpected error details", exc_info=True)
            return False
    return False


async def safe_edit_message_text_with_status(
    bot,
    chat_id: int,
    message_id: int,
    text: str,
    reply_markup=None,
    *,
    parse_mode: str | None = None,
    retries: int = 2,
    base_delay: float = 0.3,
    logger: logging.Logger | None = None,
    request_timeout: int | None = DEFAULT_REQUEST_TIMEOUT,
) -> tuple[bool, bool]:
    """Safely edit a message text, reporting network failures."""

    log = _get_logger(logger)
    if isinstance(reply_markup, (ReplyKeyboardMarkup, ReplyKeyboardRemove)):
        log.warning("Safe edit skipped due to reply keyboard markup")
        return False, False

    for attempt in range(retries + 1):
        try:
            await bot.edit_message_text(
                chat_id=chat_id,
                message_id=message_id,
                text=text,
                reply_markup=reply_markup,
                parse_mode=parse_mode,
                request_timeout=request_timeout,
            )
            return True, False
        except TelegramBadRequest as exc:
            lowered = str(exc).lower()
            if "message is not modified" in lowered:
                return True, False
            if "message to edit not found" in lowered:
                log.debug(
                    "Safe edit skipped (chat_id=%s, message_id=%s): %s",
                    chat_id,
                    message_id,
                    exc,
                )
                return False, False
            log.warning(
                "Safe edit failed (chat_id=%s, message_id=%s): %s",
                chat_id,
                message_id,
                exc,
            )
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe edit failure details", exc_info=True)
            return False, False
        except Exception as exc:  # noqa: BLE001
            if _is_network_error(exc):
                _log_network_error(log, "edit_message_text", exc, attempt + 1, retries)
                if attempt < retries:
                    await asyncio.sleep(base_delay * 2**attempt)
                    continue
                return False, True
            log.warning(
                "Safe edit unexpected error (chat_id=%s, message_id=%s): %s",
                chat_id,
                message_id,
                exc,
            )
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe edit unexpected error details", exc_info=True)
            return False, False
    return False, False


async def safe_send_message(
    bot,
    chat_id: int,
    text: str,
    reply_markup=None,
    *,
    parse_mode: str | None = None,
    retries: int = 2,
    base_delay: float = 0.3,
    logger: logging.Logger | None = None,
    request_timeout: int | None = DEFAULT_REQUEST_TIMEOUT,
):
    """Safely send a message using bot.send_message without raising exceptions."""

    log = _get_logger(logger)
    normalized = "" if text is None else str(text)
    if not normalized.strip():
        normalized = "."
    for attempt in range(retries + 1):
        try:
            return await bot.send_message(
                chat_id=chat_id,
                text=normalized,
                reply_markup=reply_markup,
                parse_mode=parse_mode,
                request_timeout=request_timeout,
            )
        except TelegramBadRequest as exc:
            log.warning("Safe send failed: %s", exc)
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe send failure details", exc_info=True)
            return None
        except Exception as exc:  # noqa: BLE001
            if _is_network_error(exc):
                _log_network_error(log, "send_message", exc, attempt + 1, retries)
                if attempt < retries:
                    await asyncio.sleep(base_delay * 2**attempt)
                    continue
                return None
            log.warning("Safe send unexpected error: %s", exc)
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe send unexpected error details", exc_info=True)
            return None
    return None


async def safe_answer(
    message_or_callback,
    text: str,
    reply_markup=None,
    *,
    parse_mode: str | None = None,
    retries: int = 2,
    base_delay: float = 0.3,
    logger: logging.Logger | None = None,
    request_timeout: int | None = DEFAULT_REQUEST_TIMEOUT,
) -> int | None:
    """Safely send a message using .answer without raising exceptions."""

    log = _get_logger(logger)
    for attempt in range(retries + 1):
        try:
            sent = await message_or_callback.answer(
                text,
                reply_markup=reply_markup,
                parse_mode=parse_mode,
                request_timeout=request_timeout,
            )
            return int(sent.message_id)
        except TelegramBadRequest as exc:
            log.warning("Safe answer failed: %s", exc)
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe answer failure details", exc_info=True)
            return None
        except Exception as exc:  # noqa: BLE001
            if _is_network_error(exc):
                _log_network_error(log, "answer", exc, attempt + 1, retries)
                if attempt < retries:
                    await asyncio.sleep(base_delay * 2**attempt)
                    continue
                return None
            log.warning("Safe answer unexpected error: %s", exc)
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe answer unexpected error details", exc_info=True)
            return None
    return None


async def safe_callback_answer(
    callback,
    text: str | None = None,
    *,
    show_alert: bool | None = None,
    logger: logging.Logger | None = None,
) -> None:
    """Safely answer a callback query without raising exceptions."""

    log = _get_logger(logger)
    try:
        await callback.answer(text=text, show_alert=show_alert)
    except Exception as exc:  # noqa: BLE001
        if _is_network_error(exc):
            log.warning("Safe callback answer failed due to network error: %s", exc)
            if log.isEnabledFor(logging.DEBUG):
                log.debug("Safe callback answer network details", exc_info=True)
            return
        log.warning("Safe callback answer unexpected error: %s", exc)
        if log.isEnabledFor(logging.DEBUG):
            log.debug("Safe callback answer unexpected error details", exc_info=True)

===== Bot/utils/text_sanitizer.py =====


"""Text sanitizers for user-facing labels."""
from __future__ import annotations

import re


_TAIL_PATTERNS = [
    r"на\s+тиньк",
    r"на\s+альфу",
    r"на\s+сбер",
    r"на\s+яндекс",
]


def sanitize_income_title(text: str) -> str:
    value = str(text or "")
    for pattern in _TAIL_PATTERNS:
        value = re.sub(rf"\s*(?:—|-|:)?\s*{pattern}", "", value, flags=re.IGNORECASE)
    value = re.sub(r"\s*\(\s*озон\s*\)", "", value, flags=re.IGNORECASE)
    value = re.sub(r"\(\s*\)", "", value)
    value = re.sub(r"\s{2,}", " ", value)
    return value.strip(" -—:\t\n")

===== Bot/utils/ui_cleanup.py =====


import logging
from typing import List

from aiogram import Bot
from aiogram.types import ReplyKeyboardMarkup, ReplyKeyboardRemove
from aiogram.fsm.context import FSMContext

from Bot.database.get_db import get_db
from Bot.utils.telegram_safe import (
    safe_delete_message,
    safe_edit_message_text,
    safe_send_message,
)

LOGGER = logging.getLogger(__name__)


async def ui_register_message(state: FSMContext, chat_id: int, message_id: int) -> None:
    """Track a UI message id for later cleanup."""

    data = await state.get_data()
    ids: List[int] = list(data.get("ui_tracked_message_ids") or [])
    if message_id not in ids:
        ids.append(int(message_id))
    if len(ids) > 300:
        ids = ids[-300:]
    current_chat_id = data.get("ui_chat_id")
    await state.update_data(
        ui_chat_id=current_chat_id if current_chat_id is not None else chat_id,
        ui_tracked_message_ids=ids,
    )


async def ui_register_protected_message(
    state: FSMContext, chat_id: int, message_id: int
) -> None:
    """Track a UI message id that should never be deleted."""

    data = await state.get_data()
    ids: List[int] = list(data.get("ui_protected_message_ids") or [])
    if message_id not in ids:
        ids.append(int(message_id))
    if len(ids) > 300:
        ids = ids[-300:]
    current_chat_id = data.get("ui_chat_id")
    await state.update_data(
        ui_chat_id=current_chat_id if current_chat_id is not None else chat_id,
        ui_protected_message_ids=ids,
    )


async def ui_register_user_message(state: FSMContext, chat_id: int, message_id: int) -> None:
    """Do not track user messages for later cleanup."""

    data = await state.get_data()
    if data.get("ui_chat_id") is None:
        await state.update_data(ui_chat_id=chat_id)


async def ui_safe_delete_message(
    bot: Bot,
    chat_id: int,
    message_id: int,
    log_context: str | None = None,
    state: FSMContext | None = None,
) -> bool:
    if state is not None:
        protected_ids = await ui_get_protected_ids(state)
        if int(message_id) in protected_ids:
            LOGGER.info("SKIP_DELETE_PROTECTED message_id=%s", message_id)
            return False
    return await safe_delete_message(
        bot,
        chat_id=chat_id,
        message_id=message_id,
        logger=LOGGER,
    )


async def ui_get_welcome_id(state: FSMContext) -> int | None:
    data = await state.get_data()
    welcome_id = data.get("ui_welcome_message_id")
    return int(welcome_id) if welcome_id is not None else None


async def ui_get_protected_ids(state: FSMContext) -> set[int]:
    welcome_id = await ui_get_welcome_id(state)
    if welcome_id is None:
        return set()
    return {int(welcome_id)}


async def ui_set_welcome_id(
    state: FSMContext, message_id: int, chat_id: int | None = None
) -> None:
    update = {"ui_welcome_message_id": int(message_id)}
    if chat_id is not None:
        update["ui_chat_id"] = int(chat_id)
    await state.update_data(**update)


async def ui_set_welcome_message(
    bot: Bot, state: FSMContext, chat_id: int, text: str
) -> int:
    welcome_id = await ui_get_welcome_id(state)
    if welcome_id is not None:
        edited = await safe_edit_message_text(
            bot,
            chat_id=chat_id,
            message_id=int(welcome_id),
            text=text,
            logger=LOGGER,
        )
        if edited:
            LOGGER.info("WELCOME reused (chat_id=%s, message_id=%s)", chat_id, welcome_id)
            return int(welcome_id)

    if welcome_id is None:
        db = get_db()
        persisted = db.get_welcome_message_id(chat_id)
        if persisted is not None:
            await ui_set_welcome_id(state, int(persisted), chat_id=chat_id)
            LOGGER.info("WELCOME reused (chat_id=%s, message_id=%s)", chat_id, persisted)
            return int(persisted)

    sent = await safe_send_message(bot, chat_id=chat_id, text=text, logger=LOGGER)
    if sent:
        await ui_set_welcome_id(state, int(sent.message_id), chat_id=chat_id)
        get_db().set_welcome_message_id(chat_id, int(sent.message_id))
        LOGGER.info("WELCOME created (chat_id=%s, message_id=%s)", chat_id, sent.message_id)
        return int(sent.message_id)
    return 0


async def ui_set_settings_mode_message(
    state: FSMContext, chat_id: int, message_id: int
) -> None:
    await ui_register_message(state, chat_id, message_id)


async def ui_set_screen_message(
    state: FSMContext, chat_id: int, message_id: int
) -> None:
    await ui_register_message(state, chat_id, message_id)
    await state.update_data(ui_screen_message_id=int(message_id), ui_chat_id=chat_id)


async def ui_track_message(
    state: FSMContext, chat_id: int, message_id: int
) -> None:
    await ui_register_message(state, chat_id, message_id)


async def ui_cleanup_to_context(
    bot: Bot,
    state: FSMContext,
    chat_id: int,
    context_name: str,
    keep_ids: List[int] | None = None,
) -> None:
    data = await state.get_data()
    tracked_ids: List[int] = list(data.get("ui_tracked_message_ids") or [])
    protected_ids = await ui_get_protected_ids(state)
    extra_protected_ids: List[int] = list(data.get("ui_protected_message_ids") or [])
    keep_id_set = {int(item) for item in (keep_ids or []) if item is not None}
    for protected_id in extra_protected_ids:
        protected_ids.add(int(protected_id))
    keep_id_set.update(protected_ids)
    delete_ids = []
    for mid in tracked_ids:
        mid_int = int(mid)
        if mid_int in keep_id_set:
            continue
        delete_ids.append(mid_int)
    kept_ids = {mid for mid in (int(item) for item in tracked_ids) if mid in keep_id_set}
    deleted_count = 0
    for message_id in delete_ids:
        deleted = await ui_safe_delete_message(
            bot,
            chat_id=chat_id,
            message_id=message_id,
            log_context=f"context={context_name}",
            state=state,
        )
        if deleted:
            deleted_count += 1

    LOGGER.info(
        "UI_CLEANUP context=%s deleted=%s kept=%s welcome_id=%s",
        context_name,
        deleted_count,
        len(kept_ids),
        await ui_get_welcome_id(state),
    )
    await state.update_data(
        ui_tracked_message_ids=list(
            {
                int(item)
                for item in (keep_ids or [])
                if item is not None
                and int(item) not in protected_ids
            }
        ),
    )


async def ui_cleanup_messages(bot: Bot, state: FSMContext, *args, **kwargs) -> None:
    data = await state.get_data()
    chat_id = kwargs.get("chat_id") or data.get("ui_chat_id")
    if chat_id is None:
        return
    await ui_cleanup_to_context(bot, state, int(chat_id), "MAIN_MENU")


async def ui_render_screen(
    bot: Bot,
    state: FSMContext,
    chat_id: int,
    text: str,
    reply_markup=None,
    parse_mode: str | None = None,
) -> int:
    data = await state.get_data()
    screen_id = data.get("ui_screen_message_id")
    if screen_id is not None and not isinstance(
        reply_markup, (ReplyKeyboardMarkup, ReplyKeyboardRemove)
    ):
        edited = await safe_edit_message_text(
            bot,
            chat_id=chat_id,
            message_id=int(screen_id),
            text=text,
            reply_markup=reply_markup,
            parse_mode=parse_mode,
            logger=LOGGER,
        )
        if edited:
            await ui_set_screen_message(state, chat_id, int(screen_id))
            return int(screen_id)
    sent = await safe_send_message(
        bot,
        chat_id=chat_id,
        text=text,
        reply_markup=reply_markup,
        parse_mode=parse_mode,
        logger=LOGGER,
    )
    if sent:
        await ui_set_screen_message(state, chat_id, sent.message_id)
        return int(sent.message_id)
    return int(screen_id or 0)

===== Bot/utils/ui_flow.py =====


import logging
from collections.abc import Awaitable, Callable
from typing import Any

from aiogram import Bot
from aiogram.fsm.context import FSMContext
from aiogram.types import Message

from Bot.utils.telegram_safe import safe_delete_message
LOGGER = logging.getLogger(__name__)


async def ui_get(state: FSMContext) -> dict[str, Any]:
    data = await state.get_data()
    return {
        "greeting_id": data.get("ui_welcome_message_id"),
        "tracked_ids": list(data.get("ui_tracked_message_ids") or []),
    }


async def ui_set_greeting(state: FSMContext, message_id: int) -> None:
    ui = await ui_get(state)
    if ui.get("greeting_id") is not None:
        return
    # greeting_id не удаляем никогда
    await state.update_data(ui_welcome_message_id=int(message_id))


async def ui_track(
    state: FSMContext, message_id: int, kind: str, screen: str | None
) -> None:
    ui = await ui_get(state)
    tracked: list[int] = list(ui.get("tracked_ids") or [])
    tracked.append(int(message_id))
    if len(tracked) > 300:
        tracked = tracked[-300:]
    await state.update_data(ui_tracked_message_ids=tracked)


async def ui_set_screen_message(
    state: FSMContext, screen: str, message_id: int
) -> None:
    await ui_track(state, message_id, kind="ui", screen=screen)


async def ui_cleanup_for_transition(
    bot: Bot, state: FSMContext, chat_id: int, keep_greeting: bool = True
) -> None:
    ui = await ui_get(state)
    greeting_id = ui.get("greeting_id") if keep_greeting else None
    tracked: list[int] = list(ui.get("tracked_ids") or [])
    ids = [int(item) for item in tracked]
    for message_id in ids:
        if greeting_id and message_id == greeting_id:
            continue
        await safe_delete_message(
            bot,
            chat_id=chat_id,
            message_id=message_id,
            logger=LOGGER,
        )
    await state.update_data(ui_tracked_message_ids=[])


async def ui_transition(
    bot: Bot,
    state: FSMContext,
    chat_id: int,
    new_screen: str,
    send_screen: Callable[[], Awaitable[Message]],
) -> Message:
    await ui_cleanup_for_transition(bot, state, chat_id, keep_greeting=True)
    sent = await send_screen()
    await ui_set_screen_message(state, new_screen, sent.message_id)
    return sent

===== __init__.py =====



===== docs/AUDIT_REPORT.md =====


# Audit Report (finance_bot v4)

## Found issues
- UI cleanup tracked multiple message lists and could retain welcome in tracked ids.
- Welcome message id was not persisted and could be duplicated after state loss.
- Direct Telegram edit/delete calls could fail on network errors or invalid reply keyboards.
- Income category titles contained bank/service suffixes and older rows were not sanitized.
- Database access used direct `FinanceDatabase()` construction across handlers.

## Fixes applied
- Unified UI tracking to `ui_tracked_message_ids` and excluded welcome from tracked ids after cleanup.
- Added persistent welcome id storage in `ui_pins` table and reused it on startup.
- Implemented safe Telegram operations with retries and guarded edits against reply keyboards.
- Added income title sanitizer and migration to update existing stored titles.
- Introduced `get_db()` for a shared database instance and updated handlers.

## Backlog / Follow-up
- Expand safe Telegram wrapper adoption in remaining handlers and services.
- Add safe reply markup editing helper if required by additional flows.

===== docs/RUNBOOK.md =====


# Runbook

## Запуск бота
```bash
python Bot/main.py
```

## Прогон тестов
```bash
pytest
```

===== finance_bot.log =====


[2025-11-25 14:56:00,395] [INFO] [database.crud] Database initialized at C:\Users\admin\PycharmProjects\v4\finance_bot\finance.db
[2025-11-25 14:56:00,396] [INFO] [__main__] Starting bot polling
[2025-11-25 14:56:00,397] [INFO] [aiogram.dispatcher] Start polling
[2025-11-25 14:56:00,637] [INFO] [aiogram.dispatcher] Run polling for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 14:56:00,876] [INFO] [handlers.start] User 838347504 started bot
[2025-11-25 14:56:00,877] [INFO] [aiogram.event] Update id=131879015 is handled. Duration 180 ms by bot id=8440100118
[2025-11-25 14:56:00,897] [INFO] [handlers.start] User 838347504 started bot
[2025-11-25 14:56:00,898] [INFO] [aiogram.event] Update id=131879016 is handled. Duration 199 ms by bot id=8440100118
[2025-11-25 14:56:00,919] [INFO] [handlers.start] User 838347504 started bot
[2025-11-25 14:56:00,919] [INFO] [aiogram.event] Update id=131879017 is handled. Duration 219 ms by bot id=8440100118
[2025-11-25 14:56:00,937] [INFO] [handlers.start] User 838347504 started bot
[2025-11-25 14:56:00,937] [INFO] [aiogram.event] Update id=131879018 is handled. Duration 236 ms by bot id=8440100118
[2025-11-25 14:57:27,080] [INFO] [handlers.start] User 838347504 started bot
[2025-11-25 14:57:27,081] [INFO] [aiogram.event] Update id=131879019 is handled. Duration 84 ms by bot id=8440100118
[2025-11-25 14:57:56,254] [INFO] [handlers.finances] User 838347504 started income calculation
[2025-11-25 14:57:56,255] [INFO] [aiogram.event] Update id=131879020 is handled. Duration 95 ms by bot id=8440100118
[2025-11-25 14:58:00,888] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 14:58:00,888] [INFO] [aiogram.event] Update id=131879021 is handled. Duration 105 ms by bot id=8440100118
[2025-11-25 14:58:02,102] [INFO] [handlers.finances] User 838347504 started income calculation
[2025-11-25 14:58:02,102] [INFO] [aiogram.event] Update id=131879022 is handled. Duration 79 ms by bot id=8440100118
[2025-11-25 14:58:10,082] [INFO] [aiogram.event] Update id=131879023 is handled. Duration 103 ms by bot id=8440100118
[2025-11-25 14:58:14,297] [INFO] [database.crud] Updated saving for user 838347504 category долги by 3000.0
[2025-11-25 14:58:14,480] [INFO] [aiogram.event] Update id=131879024 is handled. Duration 213 ms by bot id=8440100118
[2025-11-25 14:58:22,837] [INFO] [database.crud] Updated saving for user 838347504 category быт by 2000.0
[2025-11-25 14:58:23,038] [INFO] [aiogram.event] Update id=131879025 is handled. Duration 228 ms by bot id=8440100118
[2025-11-25 14:58:26,322] [INFO] [database.crud] Updated saving for user 838347504 category инвестиции by 2000.0
[2025-11-25 14:58:26,464] [INFO] [aiogram.event] Update id=131879026 is handled. Duration 161 ms by bot id=8440100118
[2025-11-25 14:58:33,379] [INFO] [database.crud] Updated saving for user 838347504 category сбережения by 2000.0
[2025-11-25 14:58:33,586] [INFO] [aiogram.event] Update id=131879027 is handled. Duration 238 ms by bot id=8440100118
[2025-11-25 14:58:36,150] [INFO] [database.crud] Updated saving for user 838347504 category спонтанные траты by 1000.0
[2025-11-25 14:58:36,237] [INFO] [database.crud] Fetched savings for user 838347504
[2025-11-25 14:58:36,314] [INFO] [aiogram.event] Update id=131879028 is handled. Duration 180 ms by bot id=8440100118
[2025-11-25 14:58:53,690] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 14:58:53,690] [INFO] [aiogram.event] Update id=131879029 is handled. Duration 161 ms by bot id=8440100118
[2025-11-25 14:58:57,875] [INFO] [database.crud] Fetched purchases for user 838347504
[2025-11-25 14:58:57,947] [INFO] [aiogram.event] Update id=131879030 is handled. Duration 75 ms by bot id=8440100118
[2025-11-25 14:58:59,960] [INFO] [aiogram.event] Update id=131879031 is handled. Duration 69 ms by bot id=8440100118
[2025-11-25 14:59:02,045] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:02,117] [INFO] [aiogram.event] Update id=131879032 is handled. Duration 73 ms by bot id=8440100118
[2025-11-25 14:59:08,043] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 14:59:08,044] [INFO] [aiogram.event] Update id=131879033 is handled. Duration 70 ms by bot id=8440100118
[2025-11-25 14:59:10,023] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 14:59:10,023] [INFO] [aiogram.event] Update id=131879034 is handled. Duration 160 ms by bot id=8440100118
[2025-11-25 14:59:14,674] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:14,749] [INFO] [aiogram.event] Update id=131879035 is handled. Duration 75 ms by bot id=8440100118
[2025-11-25 14:59:17,760] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:17,829] [INFO] [aiogram.event] Update id=131879036 is not handled. Duration 69 ms by bot id=8440100118
[2025-11-25 14:59:17,830] [ERROR] [aiogram.event] Cause exception while process update id=131879036 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 14:59:18,336] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:18,397] [INFO] [aiogram.event] Update id=131879037 is not handled. Duration 62 ms by bot id=8440100118
[2025-11-25 14:59:18,397] [ERROR] [aiogram.event] Cause exception while process update id=131879037 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 14:59:19,441] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:19,514] [INFO] [aiogram.event] Update id=131879038 is not handled. Duration 73 ms by bot id=8440100118
[2025-11-25 14:59:19,514] [ERROR] [aiogram.event] Cause exception while process update id=131879038 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 14:59:32,729] [INFO] [aiogram.event] Update id=131879039 is handled. Duration 76 ms by bot id=8440100118
[2025-11-25 14:59:34,323] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:34,386] [INFO] [aiogram.event] Update id=131879040 is not handled. Duration 63 ms by bot id=8440100118
[2025-11-25 14:59:34,387] [ERROR] [aiogram.event] Cause exception while process update id=131879040 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 14:59:36,388] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 14:59:36,388] [INFO] [aiogram.event] Update id=131879041 is handled. Duration 80 ms by bot id=8440100118
[2025-11-25 14:59:37,547] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 14:59:37,547] [INFO] [aiogram.event] Update id=131879042 is handled. Duration 147 ms by bot id=8440100118
[2025-11-25 14:59:41,835] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 14:59:41,912] [INFO] [aiogram.event] Update id=131879043 is handled. Duration 77 ms by bot id=8440100118
[2025-11-25 15:00:33,523] [INFO] [aiogram.dispatcher] Polling stopped
[2025-11-25 15:00:33,524] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 15:00:33,525] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 15:00:33,785] [INFO] [__main__] Bot shutdown complete
[2025-11-25 15:00:33,786] [INFO] [aiogram.dispatcher] Polling stopped for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 15:00:38,045] [INFO] [database.crud] Database initialized at C:\Users\admin\PycharmProjects\v4\finance_bot\finance.db
[2025-11-25 15:00:38,045] [INFO] [__main__] Starting bot polling
[2025-11-25 15:00:38,045] [INFO] [aiogram.dispatcher] Start polling
[2025-11-25 15:00:38,212] [INFO] [aiogram.dispatcher] Run polling for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 15:00:52,677] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 15:00:52,677] [INFO] [aiogram.event] Update id=131879044 is handled. Duration 219 ms by bot id=8440100118
[2025-11-25 15:00:54,702] [INFO] [handlers.finances] User 838347504 started income calculation
[2025-11-25 15:00:54,702] [INFO] [aiogram.event] Update id=131879045 is handled. Duration 108 ms by bot id=8440100118
[2025-11-25 15:00:56,190] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 15:00:56,190] [INFO] [aiogram.event] Update id=131879046 is handled. Duration 75 ms by bot id=8440100118
[2025-11-25 15:00:57,615] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 15:00:57,615] [INFO] [aiogram.event] Update id=131879047 is handled. Duration 360 ms by bot id=8440100118
[2025-11-25 15:00:58,671] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:00:58,752] [INFO] [aiogram.event] Update id=131879048 is handled. Duration 81 ms by bot id=8440100118
[2025-11-25 15:01:01,909] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:01:01,976] [INFO] [aiogram.event] Update id=131879049 is not handled. Duration 68 ms by bot id=8440100118
[2025-11-25 15:01:01,976] [ERROR] [aiogram.event] Cause exception while process update id=131879049 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 15:01:03,671] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:01:03,766] [INFO] [aiogram.event] Update id=131879050 is not handled. Duration 95 ms by bot id=8440100118
[2025-11-25 15:01:03,767] [ERROR] [aiogram.event] Cause exception while process update id=131879050 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 15:01:05,107] [INFO] [aiogram.event] Update id=131879051 is handled. Duration 128 ms by bot id=8440100118
[2025-11-25 15:01:16,920] [INFO] [aiogram.event] Update id=131879052 is handled. Duration 86 ms by bot id=8440100118
[2025-11-25 15:01:20,646] [INFO] [aiogram.event] Update id=131879053 is handled. Duration 86 ms by bot id=8440100118
[2025-11-25 15:01:27,803] [INFO] [aiogram.event] Update id=131879054 is handled. Duration 83 ms by bot id=8440100118
[2025-11-25 15:01:30,081] [INFO] [database.crud] Added wish 1 for user 838347504
[2025-11-25 15:01:30,163] [INFO] [handlers.callbacks] User 838347504 added wish 1
[2025-11-25 15:01:30,163] [INFO] [aiogram.event] Update id=131879055 is handled. Duration 115 ms by bot id=8440100118
[2025-11-25 15:01:37,618] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 15:01:37,618] [INFO] [aiogram.event] Update id=131879056 is handled. Duration 140 ms by bot id=8440100118
[2025-11-25 15:01:39,178] [INFO] [handlers.finances] User 838347504 started income calculation
[2025-11-25 15:01:39,178] [INFO] [aiogram.event] Update id=131879057 is handled. Duration 162 ms by bot id=8440100118
[2025-11-25 15:01:40,278] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 15:01:40,279] [INFO] [aiogram.event] Update id=131879058 is handled. Duration 81 ms by bot id=8440100118
[2025-11-25 15:01:42,094] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 15:01:42,094] [INFO] [aiogram.event] Update id=131879059 is handled. Duration 198 ms by bot id=8440100118
[2025-11-25 15:01:43,222] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:01:43,308] [INFO] [aiogram.event] Update id=131879060 is handled. Duration 86 ms by bot id=8440100118
[2025-11-25 15:01:48,363] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:01:48,442] [INFO] [aiogram.event] Update id=131879061 is handled. Duration 79 ms by bot id=8440100118
[2025-11-25 15:03:48,606] [INFO] [aiogram.dispatcher] Polling stopped
[2025-11-25 15:03:48,608] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 15:03:48,608] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 15:03:48,867] [INFO] [__main__] Bot shutdown complete
[2025-11-25 15:03:48,868] [INFO] [aiogram.dispatcher] Polling stopped for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 15:03:53,203] [INFO] [database.crud] Database initialized at C:\Users\admin\PycharmProjects\v4\finance_bot\finance.db
[2025-11-25 15:03:53,204] [INFO] [__main__] Starting bot polling
[2025-11-25 15:03:53,204] [INFO] [aiogram.dispatcher] Start polling
[2025-11-25 15:03:53,356] [INFO] [aiogram.dispatcher] Run polling for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 15:03:56,005] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 15:03:56,005] [INFO] [aiogram.event] Update id=131879062 is handled. Duration 176 ms by bot id=8440100118
[2025-11-25 15:03:58,443] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 15:03:58,443] [INFO] [aiogram.event] Update id=131879063 is handled. Duration 151 ms by bot id=8440100118
[2025-11-25 15:03:59,386] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:03:59,471] [INFO] [aiogram.event] Update id=131879064 is handled. Duration 86 ms by bot id=8440100118
[2025-11-25 15:04:04,361] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:04:04,432] [INFO] [aiogram.event] Update id=131879065 is handled. Duration 72 ms by bot id=8440100118
[2025-11-25 15:04:07,009] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 15:04:07,076] [INFO] [aiogram.event] Update id=131879066 is not handled. Duration 68 ms by bot id=8440100118
[2025-11-25 15:04:07,076] [ERROR] [aiogram.event] Cause exception while process update id=131879066 by bot id=8440100118
TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
Traceback (most recent call last):
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 309, in _process_update
    response = await self.feed_update(bot, update, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 158, in feed_update
    response = await self.update.wrap_outer_middleware(
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<7 lines>...
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\error.py", line 25, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\middlewares\user_context.py", line 56, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\fsm\middleware.py", line 42, in __call__
    return await handler(event, data)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\dispatcher.py", line 276, in _listen_update
    return await self.propagate_event(update_type=update_type, event=event, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 174, in _propagate_event
    response = await router.propagate_event(update_type=update_type, event=event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 146, in propagate_event
    return await observer.wrap_outer_middleware(_wrapped, event=event, data=kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 141, in _wrapped
    return await self._propagate_event(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        observer=observer, update_type=update_type, event=telegram_event, **data
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\router.py", line 166, in _propagate_event
    response = await observer.trigger(event, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\telegram.py", line 121, in trigger
    return await wrapped_inner(event, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\dispatcher\event\handler.py", line 43, in call
    return await wrapped()
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 36, in handle_category_selection
    await _send_wishes_list(callback, category)
  File "C:\Users\admin\PycharmProjects\v4\finance_bot\Bot\handlers\callbacks.py", line 66, in _send_wishes_list
    await callback.message.edit_text("Желаний в этой категории пока нет.", reply_markup=wishlist_categories_keyboard())
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\methods\base.py", line 84, in emit
    return await bot(self)
           ^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\bot.py", line 485, in __call__
    return await self.session(self, method, timeout=request_timeout)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 254, in __call__
    return cast(TelegramType, await middleware(bot, method))
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\aiohttp.py", line 185, in make_request
    response = self.check_response(
        bot=bot, method=method, status_code=resp.status, content=raw_result
    )
  File "C:\Users\admin\AppData\Local\Programs\Python\Python313\Lib\site-packages\aiogram\client\session\base.py", line 120, in check_response
    raise TelegramBadRequest(method=method, message=description)
aiogram.exceptions.TelegramBadRequest: Telegram server says - Bad Request: message is not modified: specified new message content and reply markup are exactly the same as a current content and reply markup of the message
[2025-11-25 16:18:28,663] [INFO] [aiogram.dispatcher] Polling stopped
[2025-11-25 16:18:28,665] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 16:18:28,665] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 16:18:28,929] [INFO] [__main__] Bot shutdown complete
[2025-11-25 16:18:28,929] [INFO] [aiogram.dispatcher] Polling stopped for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 16:22:08,148] [INFO] [database.crud] Database initialized at C:\Users\admin\PycharmProjects\v4\finance_bot\finance.db
[2025-11-25 16:22:08,148] [INFO] [__main__] Starting bot polling
[2025-11-25 16:22:08,148] [INFO] [aiogram.dispatcher] Start polling
[2025-11-25 16:22:08,311] [INFO] [aiogram.dispatcher] Run polling for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 16:22:37,723] [INFO] [handlers.start] User 838347504 started bot
[2025-11-25 16:22:37,723] [INFO] [aiogram.event] Update id=131879067 is handled. Duration 264 ms by bot id=8440100118
[2025-11-25 16:22:44,393] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 16:22:44,394] [INFO] [aiogram.event] Update id=131879068 is handled. Duration 145 ms by bot id=8440100118
[2025-11-25 16:22:46,433] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 16:22:46,509] [INFO] [aiogram.event] Update id=131879069 is handled. Duration 77 ms by bot id=8440100118
[2025-11-25 16:22:56,829] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 16:22:56,887] [INFO] [aiogram.event] Update id=131879070 is handled. Duration 59 ms by bot id=8440100118
[2025-11-25 16:23:03,206] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 16:23:03,308] [INFO] [aiogram.event] Update id=131879071 is handled. Duration 103 ms by bot id=8440100118
[2025-11-25 16:23:05,570] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 16:23:05,658] [INFO] [aiogram.event] Update id=131879072 is handled. Duration 88 ms by bot id=8440100118
[2025-11-25 16:23:07,180] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 16:23:07,258] [INFO] [aiogram.event] Update id=131879073 is handled. Duration 78 ms by bot id=8440100118
[2025-11-25 16:23:16,044] [INFO] [database.crud] Fetched wish 1
[2025-11-25 16:23:16,044] [INFO] [database.crud] Fetched savings for user 838347504
[2025-11-25 16:23:16,179] [INFO] [aiogram.event] Update id=131879074 is handled. Duration 135 ms by bot id=8440100118
[2025-11-25 16:23:19,804] [INFO] [database.crud] Fetched wish 1
[2025-11-25 16:23:19,804] [INFO] [database.crud] Fetched savings for user 838347504
[2025-11-25 16:23:19,861] [INFO] [aiogram.event] Update id=131879075 is handled. Duration 58 ms by bot id=8440100118
[2025-11-25 16:23:38,225] [INFO] [handlers.start] User 838347504 returned to main menu
[2025-11-25 16:23:38,225] [INFO] [aiogram.event] Update id=131879076 is handled. Duration 134 ms by bot id=8440100118
[2025-11-25 16:23:45,038] [INFO] [handlers.finances] User 838347504 started income calculation
[2025-11-25 16:23:45,038] [INFO] [aiogram.event] Update id=131879077 is handled. Duration 76 ms by bot id=8440100118
[2025-11-25 16:23:50,008] [INFO] [aiogram.event] Update id=131879078 is handled. Duration 86 ms by bot id=8440100118
[2025-11-25 16:23:51,364] [INFO] [database.crud] Updated saving for user 838347504 category долги by 300000.0
[2025-11-25 16:23:51,518] [INFO] [aiogram.event] Update id=131879079 is handled. Duration 171 ms by bot id=8440100118
[2025-11-25 16:23:52,687] [INFO] [database.crud] Updated saving for user 838347504 category быт by 200000.0
[2025-11-25 16:23:52,833] [INFO] [aiogram.event] Update id=131879080 is handled. Duration 164 ms by bot id=8440100118
[2025-11-25 16:23:53,859] [INFO] [database.crud] Updated saving for user 838347504 category инвестиции by 200000.0
[2025-11-25 16:23:54,019] [INFO] [aiogram.event] Update id=131879081 is handled. Duration 190 ms by bot id=8440100118
[2025-11-25 16:23:54,966] [INFO] [database.crud] Updated saving for user 838347504 category сбережения by 200000.0
[2025-11-25 16:23:55,293] [INFO] [aiogram.event] Update id=131879082 is handled. Duration 349 ms by bot id=8440100118
[2025-11-25 16:23:57,121] [INFO] [database.crud] Updated saving for user 838347504 category спонтанные траты by 100000.0
[2025-11-25 16:23:57,188] [INFO] [database.crud] Fetched savings for user 838347504
[2025-11-25 16:23:57,259] [INFO] [aiogram.event] Update id=131879083 is handled. Duration 144 ms by bot id=8440100118
[2025-11-25 16:24:07,221] [INFO] [handlers.wishlist] User 838347504 opened wishlist
[2025-11-25 16:24:07,221] [INFO] [aiogram.event] Update id=131879084 is handled. Duration 155 ms by bot id=8440100118
[2025-11-25 16:24:08,753] [INFO] [database.crud] Fetched wishes for user 838347504
[2025-11-25 16:24:08,822] [INFO] [aiogram.event] Update id=131879085 is handled. Duration 70 ms by bot id=8440100118
[2025-11-25 16:24:20,015] [INFO] [database.crud] Fetched wish 1
[2025-11-25 16:24:20,015] [INFO] [database.crud] Fetched savings for user 838347504
[2025-11-25 16:24:20,110] [INFO] [aiogram.event] Update id=131879086 is handled. Duration 96 ms by bot id=8440100118
[2025-11-25 16:24:45,843] [INFO] [handlers.common] Fallback triggered. User: 838347504 State: None Text: None
[2025-11-25 16:24:45,922] [INFO] [aiogram.event] Update id=131879087 is handled. Duration 81 ms by bot id=8440100118
[2025-11-25 16:52:04,024] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 16:52:04,025] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 16:52:15,199] [INFO] [aiogram.dispatcher] Connection established (tryings = 1, bot id = 8440100118)
[2025-11-25 16:52:15,200] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 16:52:15,200] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 16:52:26,359] [INFO] [aiogram.dispatcher] Connection established (tryings = 1, bot id = 8440100118)
[2025-11-25 17:13:12,505] [INFO] [aiogram.dispatcher] Polling stopped
[2025-11-25 17:13:12,507] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 17:13:12,507] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 17:13:12,768] [INFO] [__main__] Bot shutdown complete
[2025-11-25 17:13:12,769] [INFO] [aiogram.dispatcher] Polling stopped for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 17:25:52,747] [INFO] [database.crud] Database initialized at C:\Users\admin\PycharmProjects\v4\finance_bot\finance.db
[2025-11-25 17:25:52,748] [INFO] [__main__] Starting bot polling
[2025-11-25 17:25:52,748] [INFO] [aiogram.dispatcher] Start polling
[2025-11-25 17:25:52,929] [INFO] [aiogram.dispatcher] Run polling for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'
[2025-11-25 17:34:36,059] [INFO] [aiogram.dispatcher] Polling stopped
[2025-11-25 17:34:36,060] [ERROR] [aiogram.dispatcher] Failed to fetch updates - TelegramNetworkError: HTTP Client says - ServerDisconnectedError: Server disconnected
[2025-11-25 17:34:36,060] [WARNING] [aiogram.dispatcher] Sleep for 1.000000 seconds and try again... (tryings = 0, bot id = 8440100118)
[2025-11-25 17:34:36,314] [INFO] [__main__] Bot shutdown complete
[2025-11-25 17:34:36,315] [INFO] [aiogram.dispatcher] Polling stopped for bot @IanDyniBot id=8440100118 - 'Моя Боль ЯньДунь'

===== tests/__init__.py =====



===== tests/integration/__init__.py =====



===== tests/integration/test_database.py =====


"""Integration tests for database operations."""
from Bot.database.crud import FinanceDatabase, TABLES


def setup_module(module) -> None:  # noqa: D401
    """Clean database tables before tests."""

    db = FinanceDatabase()
    cursor = db.connection.cursor()
    cursor.execute(f"DELETE FROM {TABLES.wishes}")
    cursor.execute(f"DELETE FROM {TABLES.purchases}")
    cursor.execute(f"DELETE FROM {TABLES.savings}")
    db.connection.commit()


def test_add_and_get_wish() -> None:
    """Add wish and retrieve it."""

    db = FinanceDatabase()
    wish_id = db.add_wish(1, "Test", 10.0, None, "Инструменты")
    wish = db.get_wish(wish_id)
    assert wish is not None
    assert wish["name"] == "Test"


def test_update_saving_and_purchase() -> None:
    """Update savings and add purchase entry."""

    db = FinanceDatabase()
    db.update_saving(1, "Инструменты", 20.0)
    savings = db.get_user_savings(1)
    assert savings.get("Инструменты", {}).get("current") == 20.0
    db.add_purchase(1, "Test", 10.0, "Инструменты")
    purchases = db.get_purchases_by_user(1)
    assert len(purchases) == 1

===== tests/integration/test_schema_migration.py =====


"""Integration tests for schema migration."""
from __future__ import annotations

import sqlite3
from pathlib import Path

from Bot.database.crud import TABLES, migrate_schema


def test_schema_migration_renames_tables(tmp_path: Path) -> None:
    """Rename legacy tables without losing data."""

    db_path = tmp_path / "legacy.db"
    connection = sqlite3.connect(db_path)
    cursor = connection.cursor()
    cursor.execute(
        """
        CREATE TABLE savings (
            id INTEGER PRIMARY KEY,
            user_id INTEGER,
            category TEXT,
            current REAL
        )
        """
    )
    cursor.execute(
        """
        CREATE TABLE wishes (
            id INTEGER PRIMARY KEY,
            user_id INTEGER,
            name TEXT,
            price REAL,
            category TEXT,
            is_purchased INTEGER,
            saved_amount REAL,
            purchased_at TEXT
        )
        """
    )
    cursor.execute(
        """
        CREATE TABLE purchases (
            id INTEGER PRIMARY KEY,
            user_id INTEGER,
            wish_name TEXT,
            price REAL,
            category TEXT,
            purchased_at TEXT
        )
        """
    )
    cursor.execute(
        """
        CREATE TABLE household_payment_items (
            id INTEGER PRIMARY KEY,
            user_id INTEGER,
            code TEXT,
            text TEXT,
            amount INTEGER,
            position INTEGER,
            is_active INTEGER
        )
        """
    )
    cursor.execute(
        """
        CREATE TABLE household_payments (
            id INTEGER PRIMARY KEY,
            user_id INTEGER,
            month TEXT,
            question_code TEXT,
            is_paid INTEGER
        )
        """
    )
    cursor.execute(
        "INSERT INTO savings (user_id, category, current) VALUES (?,?,?)",
        (1, "БЫТ", 500.0),
    )
    cursor.execute(
        """
        INSERT INTO wishes (user_id, name, price, category, is_purchased, saved_amount, purchased_at)
        VALUES (?,?,?,?,?,?,?)
        """,
        (1, "Чайник", 1200.0, "БЫТ", 0, 0, None),
    )
    cursor.execute(
        "INSERT INTO purchases (user_id, wish_name, price, category, purchased_at) VALUES (?,?,?,?,?)",
        (1, "Тест", 100.0, "БЫТ", "2025-01-01"),
    )
    cursor.execute(
        """
        INSERT INTO household_payment_items (user_id, code, text, amount, position, is_active)
        VALUES (?,?,?,?,?,?)
        """,
        (1, "rent", "Квартплата", 4000, 1, 1),
    )
    cursor.execute(
        """
        INSERT INTO household_payments (user_id, month, question_code, is_paid)
        VALUES (?,?,?,?)
        """,
        (1, "2025-01", "rent", 0),
    )
    connection.commit()

    migrate_schema(connection)
    migrate_schema(connection)

    cursor.execute(f"SELECT category, current FROM {TABLES.savings}")
    savings_row = cursor.fetchone()
    assert savings_row == ("БЫТ", 500.0)

    cursor.execute(f"SELECT name FROM {TABLES.wishes}")
    assert cursor.fetchone()[0] == "Чайник"

    cursor.execute(f"SELECT wish_name FROM {TABLES.purchases}")
    assert cursor.fetchone()[0] == "Тест"

    cursor.execute(f"SELECT code FROM {TABLES.household_payment_items}")
    assert cursor.fetchone()[0] == "rent"

    cursor.execute(f"SELECT question_code FROM {TABLES.household_payments}")
    assert cursor.fetchone()[0] == "rent"

    connection.close()

===== tests/run_all_tests.py =====


"""Run all pytest suites."""
import pytest


if __name__ == "__main__":
    raise SystemExit(pytest.main(["-q", "tests"]))

===== tests/test_runner.py =====


"""Helper to run tests programmatically."""
import subprocess
import sys
from pathlib import Path


def main() -> int:
    """Run pytest suite and return exit code."""

    root = Path(__file__).resolve().parents[1]
    result = subprocess.run([sys.executable, "-m", "pytest", "-q", str(root / "tests")], check=False)
    return result.returncode


if __name__ == "__main__":
    raise SystemExit(main())

===== tests/unit/__init__.py =====



===== tests/unit/test_handlers.py =====


"""Tests for handler utilities."""
from Bot.handlers.finances import _format_savings_summary, _find_reached_goal


def test_format_savings_summary_empty() -> None:
    """Empty savings returns default message."""

    assert _format_savings_summary({}) == "Пока нет накоплений."


def test_find_reached_goal() -> None:
    """Goal detection returns first satisfied category."""

    savings = {
        "категория": {"current": 150, "goal": 100, "purpose": "test"},
        "другая": {"current": 50, "goal": 100, "purpose": "none"},
    }
    category, data = _find_reached_goal(savings)
    assert category == "категория"
    assert data["goal"] == 100

===== tests/unit/test_household_debit_category.py =====


"""Tests for household debit category settings."""
from Bot.database import crud


def _fresh_db(tmp_path, monkeypatch) -> crud.FinanceDatabase:
    db_path = tmp_path / "finance.db"
    monkeypatch.setattr(crud, "DB_PATH", db_path)
    crud.FinanceDatabase._instance = None
    return crud.FinanceDatabase()


def test_set_and_get_household_debit_category(tmp_path, monkeypatch) -> None:
    """Household debit category should persist in user settings."""

    db = _fresh_db(tmp_path, monkeypatch)
    try:
        db.set_household_debit_category(1, "alpha")
        assert db.get_household_debit_category(1) == "alpha"
    finally:
        db.close()
        crud.FinanceDatabase._instance = None


def test_apply_household_debit_category_updates_savings(tmp_path, monkeypatch) -> None:
    """Yes answer should debit savings from selected category."""

    db = _fresh_db(tmp_path, monkeypatch)
    try:
        db.set_household_debit_category(2, "custom_cat")
        changed = db.apply_household_payment_answer(
            user_id=2,
            month="2026-01",
            question_code="q1",
            amount=100.0,
            answer="yes",
            debit_category="custom_cat",
        )
        assert changed is True
        savings_map = db.get_user_savings_map(2)
        assert savings_map.get("custom_cat") == -100.0
    finally:
        db.close()
        crud.FinanceDatabase._instance = None


def test_resolve_household_debit_category_fallback(tmp_path, monkeypatch) -> None:
    """Fallback should select first available income category."""

    db = _fresh_db(tmp_path, monkeypatch)
    try:
        cursor = db.connection.cursor()
        cursor.execute(
            f"""
            INSERT INTO {crud.TABLES.income_categories} (user_id, code, title, percent, position, is_active)
            VALUES (?, ?, ?, ?, ?, 1)
            """,
            (3, "alpha", "Alpha", 50, 1),
        )
        cursor.execute(
            f"""
            INSERT INTO {crud.TABLES.income_categories} (user_id, code, title, percent, position, is_active)
            VALUES (?, ?, ?, ?, ?, 1)
            """,

===== Bot/utils/byt_utils.py =====

"""Utilities for BYT reminder source category."""

from __future__ import annotations

import logging
from typing import Optional

from Bot.database.crud import FinanceDatabase

LOGGER = logging.getLogger(__name__)


def normalize_wishlist_category_title(value: str) -> str:
    """Normalize wishlist category titles for comparison."""

    normalized = str(value or "").strip().casefold()
    if normalized == "byt":
        return "быт"
    return normalized


def wishlist_category_matches(wish_category: str, source_title: str) -> bool:
    """Return True when wish category matches selected BYT source."""

    return normalize_wishlist_category_title(wish_category) == normalize_wishlist_category_title(
        source_title
    )


def get_byt_source_category_id(db: FinanceDatabase, user_id: int) -> Optional[int]:
    """Return BYT source wishlist category id with fallback by name."""

    db.ensure_user_settings(user_id)
    settings_row = db.get_user_settings(user_id)
    raw_id = settings_row.get("byt_wishlist_category_id")
    category_id: Optional[int] = None
    if raw_id is not None:
        try:
            category_id = int(raw_id)
        except (TypeError, ValueError):
            category_id = None
    if category_id is not None:
        category_row = db.get_wishlist_category_by_id(user_id, category_id)
        if category_row:
            return int(category_row.get("id"))
        db.set_byt_wishlist_category_id(user_id, None)

    fallback = db.get_wishlist_category_by_title(user_id, "быт")
    if fallback:
        fallback_id = int(fallback.get("id"))
        db.set_byt_wishlist_category_id(user_id, fallback_id)
        LOGGER.info(
            "USER=%s ACTION=BYT_SOURCE_CATEGORY_SET META=category_id=%s",
            user_id,
            fallback_id,
        )
        return fallback_id
    return None


def get_byt_source_category(
    db: FinanceDatabase, user_id: int
) -> tuple[Optional[int], Optional[str]]:
    """Return BYT source category id and title."""

    category_id = get_byt_source_category_id(db, user_id)
    if category_id is None:
        return None, None
    category_row = db.get_wishlist_category_by_id(user_id, category_id)
    if not category_row:
        return None, None
    return category_id, str(category_row.get("title", ""))
